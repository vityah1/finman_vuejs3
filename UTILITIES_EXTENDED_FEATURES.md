# Розширені можливості обліку комунальних платежів

## Огляд змін

Система обліку комунальних платежів тепер підтримує:
- **Групування тарифів** - можливість об'єднувати пов'язані тарифи (наприклад, розхід і злив води)
- **Множинні показники** - введення декількох показників для одної служби (денний/нічний для електрики)
- **Деталізовані розрахунки** - відображення покомпонентного розрахунку вартості
- **Гнучкі методи розрахунку** - підтримка відсоткових тарифів та фіксованих сум

## Налаштування тарифів

### Для води (один показник, декілька тарифів)

1. **Створіть службу "Водопостачання"**
2. **Додайте групу тарифів:**
   - **Тариф на розхід води:**
     - Тип тарифу: `Споживання`
     - Код групи: `water_2025`
     - Метод розрахунку: `Стандартний`
     - Ставка: 25.50 грн/м³
     - Абонплата: 15.00 грн
   
   - **Тариф на водовідведення:**
     - Тип тарифу: `Водовідведення`
     - Код групи: `water_2025`
     - Метод розрахунку: `Відсоток від основного`
     - Відсоток: 80%

При введенні показників система автоматично розрахує:
- Вартість розходу води = споживання × тариф
- Вартість водовідведення = вартість розходу × 80%
- Додасть абонплату
- Покаже загальну суму

### Для електроенергії (декілька показників)

1. **Створіть службу "Електроенергія"**
2. **Додайте тарифи:**
   - **Денний тариф:**
     - Тип тарифу: `Денний`
     - Код групи: `electricity_2025`
     - Ставка: 2.64 грн/кВт·год
   
   - **Нічний тариф:**
     - Тип тарифу: `Нічний`
     - Код групи: `electricity_2025`
     - Ставка: 1.32 грн/кВт·год

При введенні показників з'являться окремі поля для денного та нічного показників.

## Використання на фронтенді

### Компонент TariffList.vue

Тепер відображає:
- Тип тарифу (споживання, водовідведення, денний, нічний)
- Код групи для пов'язаних тарифів
- Метод розрахунку та відсоток (якщо застосовується)

### Компонент AddReading.vue

**Автоматичне визначення типу служби:**
- Якщо назва служби містить "вода" - один показник з груповим розрахунком
- Якщо назва служби містить "електр" - множинні показники (день/ніч)
- Інші служби - стандартний режим

**Для води:**
- Один input для введення показника
- Автоматичний розрахунок всіх компонентів
- Відображення детального розрахунку

**Для електрики:**
- Окремі карточки для денного та нічного показників
- Розрахунок споживання для кожного типу
- Сумарна вартість

### Компонент ReadingList.vue

**Нові можливості:**
- Кнопка інформації біля суми для перегляду деталей
- Розгортний блок з покомпонентним розрахунком
- Відображення використаних тарифів

## API Endpoints

### Нові endpoints:

```http
GET /api/utilities/tariffs/grouped/{service_id}?period=2025-01
```
Отримання згрупованих тарифів для служби

```http
POST /api/utilities/readings/batch
```
Створення декількох показників одночасно (для електрики)

```http
GET /api/utilities/readings/detailed/{service_id}?period=2025-01
```
Отримання показників з деталізованими розрахунками

## Міграція існуючих даних

Для існуючих тарифів рекомендується:

1. **Додати типи тарифів:**
   - Для води: `consumption` для основного тарифу
   - Для електрики: `day` для існуючих тарифів

2. **Додати коди груп:**
   - Використовуйте формат `{service}_{year}`
   - Приклад: `water_2025`, `electricity_2025`

3. **Створити додаткові тарифи:**
   - Для води: тариф на водовідведення
   - Для електрики: нічний тариф

## Поради для розробників

### Визначення типу служби
```javascript
const isWaterService = computed(() => {
  const name = selectedService.value?.name.toLowerCase();
  return name.includes('вода') || name.includes('water');
});
```

### Робота з груповими тарифами
```javascript
const groupedTariffs = computed(() => {
  const groups = {};
  tariffs.forEach(tariff => {
    const type = tariff.tariff_type || 'standard';
    if (!groups[type]) groups[type] = [];
    groups[type].push(tariff);
  });
  return groups;
});
```

### Парсинг деталей розрахунку
```javascript
const getCalculationDetails = (reading) => {
  if (!reading.calculation_details) return null;
  try {
    return JSON.parse(reading.calculation_details);
  } catch (e) {
    return null;
  }
};
```

## Приклад структури calculation_details

```json
{
  "components": [
    {
      "name": "Розхід води",
      "type": "consumption",
      "consumption": 10.5,
      "rate": 25.50,
      "amount": 267.75
    },
    {
      "name": "Водовідведення",
      "type": "drainage",
      "consumption": 10.5,
      "rate": 0,
      "percentage_of": 80,
      "amount": 214.20
    }
  ],
  "total_amount": 496.95,
  "subscription_fee": 15.00
}
```

## Обмеження

- Типи тарифів визначаються за назвою служби (потребує правильного найменування)
- Для електрики підтримується лише два типи показників (день/ніч)
- Групові тарифи повинні мати однаковий `group_code`
- Відсоткові тарифи працюють лише з `calculation_method: percentage`

## Майбутні покращення

1. **Додати поле `service_type` в модель UtilityService** для явного визначення типу
2. **Підтримка більше двох показників** для складніших тарифних планів
3. **Шаблони тарифів** для швидкого налаштування нових служб
4. **Інтеграція з API постачальників** для автоматичного отримання тарифів
